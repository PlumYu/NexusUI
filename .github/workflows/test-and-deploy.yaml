name: Test and deploy

on:
  push:
    branches:
      - master

jobs:
  test:
    name: Run Lint and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4 # 推荐更新到 v4，虽然 v3 也行

      - name: Setup Node # 推荐更新到 v4，并启用 pnpm 缓存
        uses: actions/setup-node@v4
        with:
          node-version: "20" # 建议明确指定 Node.js 版本，如 '18' 或 '20'
          cache: "pnpm" # 启用 pnpm 缓存，会根据 pnpm-lock.yaml 自动处理

      - name: Setup pnpm # <--- 这里是关键修改！替换原来的 'npm install -g pnpm'
        uses: pnpm/action-setup@v3 # 使用 pnpm 官方 action
        with:
          version: 8 # **设置为你本地的 pnpm 主版本号**
          run_install: false # 不在此步骤自动运行 install

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: npm run test

  build:
    name: Build docs
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4 # 推荐更新到 v4

      - name: Setup Node # 推荐更新到 v4，并启用 pnpm 缓存
        uses: actions/setup-node@v4
        with:
          node-version: "20" # 建议明确指定 Node.js 版本
          cache: "pnpm"

      - name: Setup pnpm # <--- 这里是关键修改！替换原来的 'npm install -g pnpm'
        uses: pnpm/action-setup@v3
        with:
          version: 8 # **设置为你本地的 pnpm 主版本号**
          run_install: false

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build docs
        run: npm run docs:build

      - name: Upload docs
        uses: actions/upload-artifact@v3
        with:
          name: docs
          path: ./packages/docs/.vitepress/dist

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download docs
        uses: actions/download-artifact@v3
        with:
          name: docs

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GH_TOKEN }}
          publish_dir: .
